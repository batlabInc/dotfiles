var mongoose = require('../db/setup.js'); 
var validate = require('../validator/validate.js');

var db = require('../db/setup.js');
var User = db.getUserModel();

var app= require('../app');

exports.einloggen = function(req, res) {
  res.render('einloggen', { title: 'Einloggen' });
  console.log("REq come here");
};

exports.processPost = function (req, res) {
    console.log("We are processing");

    var newUser={};
    newUser.username= req.body.username; 
    newUser.password= req.body.password; 

    var richtig = validate.validate(req, newUser);
    console.log(richtig);

    if( richtig )
    {
         
        var isError=authentification(newUser);

        console.log(isError);
        if(!isError)
        {
            req.session.currentUser=newUser.username; 
            req.session.isLogged=true;  
        }
        else
        {
            req.session.currentUser = null; 
            req.session.isLogged = false;  
        }
    }

    console.log("sesssion",req.session);

};

function authentification( newUser ) {//{{{
    var isError = true; 

    User.findOne({"_id": newUser.username}, function (err, user) {
        if(err) {
            console.error("no user with this name");
        }
        else
        {
            //isError = user.authentificate(newUser.password);
            console.log(user);
            isError = false; 
        }
    });

    return isError; 
}//}}}

exports.userspace= function(req, res){
    res.render("app-template", {title: 'welcome user'});
};



